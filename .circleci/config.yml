version: 2.1

orbs:
  nx: nrwl/nx@1.7.0

jobs:
  main:
    docker:
      - image: cimg/node:lts-browsers
    steps:
      - checkout

      # ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      - run: npm ci
      - run: npx playwright install --with-deps

      # ØªØ«Ø¨ÙŠØª Netlify CLI
      - run:
          name: Install Netlify CLI
          command: npm install -g netlify-cli

      # ğŸŒŸ Ø¨Ø¯Ø¡ Deploy Marker
      - run:
          name: Plan a deploy
          command: |
            circleci run release plan \
              --environment-name="production" \
              --component-name="E-Commerce" \
              --target-version="$CIRCLE_SHA1"

      # Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù€ build ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
      - run:
          command: npx nx run-many -t lint test build e2e

      # ğŸŒŸ Ù†Ø´Ø± Ø¹Ù„Ù‰ Netlify
      - run:
          name: Deploy to Netlify
          command: |
            netlify deploy --prod --auth $NETLIFY_AUTH_TOKEN --site $NETLIFY_SITE_ID --dir=dist/apps/E-Commerce

      # ğŸŒŸ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ù‰ SUCCESS Ø¥Ø°Ø§ Ù†Ø¬Ø­
      - run:
          name: Update a deploy to SUCCESS
          command: circleci run release update --status=SUCCESS
          when: on_success

      # ğŸŒŸ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ù‰ FAILED Ø¥Ø°Ø§ ÙØ´Ù„
      - run:
          name: Update planned deploy to FAILED
          command: circleci run release update --status=FAILED
          when: on_fail

      # Ø¥ØµÙ„Ø§Ø­ CI ÙÙŠ Nx Cloud (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      - run:
          command: npx nx fix-ci
          when: always

workflows:
  version: 2
  ci:
    jobs:
      - main
      
