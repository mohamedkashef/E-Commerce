version: 2.1

orbs:
  nx: nrwl/nx@1.7.0

jobs:
  build_and_deploy:
    docker:
      - image: cimg/node:lts-browsers

    steps:
      - checkout

      # ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      - run: npm ci
      - run: npx playwright install --with-deps

      # ØªØ«Ø¨ÙŠØª Netlify CLI
      - run:
          name: Install Netlify CLI
          command: npm install -g netlify-cli

      # ğŸ”¥ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
      - run:
          name: Select Environment (Prod / Dev / Staging)
          command: |
            if [ "${CIRCLE_BRANCH}" == "main" ]; then
              echo "ğŸ“¦ Environment: PRODUCTION"
              export BUILD_ENV=production
              export NETLIFY_SITE_ID=$NETLIFY_SITE_ID_PROD

            elif [ "${CIRCLE_BRANCH}" == "development" ]; then
              echo "ğŸ“¦ Environment: DEVELOPMENT"
              export BUILD_ENV=development
              export NETLIFY_SITE_ID=$NETLIFY_SITE_ID_DEV

            elif [ "${CIRCLE_BRANCH}" == "staging" ]; then
              echo "ğŸ“¦ Environment: STAGING"
              export BUILD_ENV=staging
              export NETLIFY_SITE_ID=$NETLIFY_SITE_ID_STAGING

            else
              echo "âŒ Unknown branch -- stopping"
              exit 1
            fi

            # Ø­ÙØ¸ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ù€ steps Ø§Ù„ØªØ§Ù„ÙŠØ©
            echo "BUILD_ENV=$BUILD_ENV" >> $BASH_ENV
            echo "NETLIFY_SITE_ID=$NETLIFY_SITE_ID" >> $BASH_ENV

      # Source ENV variables
      - run: source $BASH_ENV

      # ğŸŒŸ Deployment Marker
      - run:
          name: Plan a deploy
          command: |
            circleci run release plan \
              --environment-name="$BUILD_ENV" \
              --component-name="E-Commerce" \
              --target-version="$CIRCLE_SHA1"

      # ğŸŒŸ Build Angular SSR
      - run:
          name: Build Angular SSR App
          command: |
            npx nx build E-Commerce --configuration=$BUILD_ENV

      # ğŸŒŸ Deploy to Netlify (browser folder for SSR plugin)
      - run:
          name: Deploy to Netlify (SSR)
          command: |
            netlify deploy \
              --prod \
              --auth $NETLIFY_AUTH_TOKEN \
              --site $NETLIFY_SITE_ID \
              --dir=dist/apps/E-Commerce/browser

      # ğŸŒŸ Update deployment status
      - run:
          name: Update Deployment to SUCCESS
          command: circleci run release update --status=SUCCESS
          when: on_success

      - run:
          name: Update Deployment to FAILED
          command: circleci run release update --status=FAILED
          when: on_fail

      # Ø¥ØµÙ„Ø§Ø­ CI ÙÙŠ Nx Cloud (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      - run:
          command: npx nx fix-ci
          when: always

workflows:
  version: 2
  deploy:
    jobs:
      - build_and_deploy
