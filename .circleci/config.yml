version: 2.1

orbs:
  nx: nrwl/nx@1.7.0

jobs:
  build_and_deploy:
    docker:
      - image: cimg/node:lts-browsers

    steps:
      - checkout

      # Install dependencies
      - run: npm ci
      - run: npx playwright install --with-deps

      # Install Netlify CLI
      - run:
          name: Install Netlify CLI
          command: npm install -g netlify-cli

      # ðŸ”¥ Select Environment Based on Branch
      - run:
          name: Select Environment (Prod / Dev / Staging)
          command: |
            if [ "${CIRCLE_BRANCH}" == "main" ]; then
              echo "ðŸ“¦ Environment: PRODUCTION"
              export BUILD_ENV=production
              export NETLIFY_SITE_ID=$NETLIFY_SITE_ID_PROD

            elif [ "${CIRCLE_BRANCH}" == "development" ]; then
              echo "ðŸ“¦ Environment: DEVELOPMENT"
              export BUILD_ENV=development
              export NETLIFY_SITE_ID=$NETLIFY_SITE_ID_DEV

            elif [ "${CIRCLE_BRANCH}" == "staging" ]; then
              echo "ðŸ“¦ Environment: STAGING"
              export BUILD_ENV=staging
              export NETLIFY_SITE_ID=$NETLIFY_SITE_ID_STAGING

            else
              echo "âŒ Unknown branch -- stopping"
              exit 1
            fi

            echo "Using BUILD_ENV=$BUILD_ENV"
            echo "Using NETLIFY_SITE_ID=$NETLIFY_SITE_ID"

            echo "BUILD_ENV=$BUILD_ENV" >> $BASH_ENV
            echo "NETLIFY_SITE_ID=$NETLIFY_SITE_ID" >> $BASH_ENV

      # ðŸ›  Source ENV variables
      - run: source $BASH_ENV

      # ðŸ”¥ Deployment Marker
      - run:
          name: Plan a deploy
          command: |
            circleci run release plan \
              --environment-name="$BUILD_ENV" \
              --component-name="E-Commerce" \
              --target-version="$CIRCLE_SHA1"

      # Build Angular using selected config
      - run:
          name: Build Angular App
          command: |
            npx nx build E-Commerce --configuration=$BUILD_ENV

      # ðŸ”¥ Deploy to Netlify
      - run:
          name: Deploy to Netlify
          command: |
            netlify deploy \
              --prod \
              --auth $NETLIFY_AUTH_TOKEN \
              --site $NETLIFY_SITE_ID \
              --dir=dist/apps/E-Commerce

      # Update deploy state
      - run:
          name: Update Deployment to SUCCESS
          command: circleci run release update --status=SUCCESS
          when: on_success

      - run:
          name: Update Deployment to FAILED
          command: circleci run release update --status=FAILED
          when: on_fail

      - run:
          command: npx nx fix-ci
          when: always


workflows:
  version: 2
  deploy:
    jobs:
      - build_and_deploy

